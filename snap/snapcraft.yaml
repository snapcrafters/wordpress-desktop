name: wordpress-desktop
adopt-info: wordpress-desktop
summary: WordPress.com Desktop client
description: |
 A desktop app that gives WordPress a permanent home in your dock.
 .
 Write and design with no other browser tabs to distract you. Switch
 easily between managing your WordPress sites and your favorite desktop
 apps.
 .
 The WordPress.com desktop app will scale to any size. Do you need a
 small window on the side to keep your eye on notifications, or do want
 to expand to a truly full screen for a zen writing experience? Take
 your pick.
base: core18

grade: stable
confinement: strict

architectures:
  - build-on: amd64

parts:
  wordpress-desktop:
    plugin: dump
    source: https://public-api.wordpress.com/rest/v1.1/desktop/linux/download?type=deb
    source-type: deb
    override-build: |
      DEB_API="https://public-api.wordpress.com/rest/v1.1/desktop/linux/download?type=deb"
      echo $DEB_API
      VERSION=$(curl -IXGET -s  $DEB_API | grep -i Content-Disposition | awk -F '"' '{print $2}' | awk -F '-' '{print $4}' | awk -F '.' '{print $1,$2,$3}' | tr ' ' '.')
      echo "Version: $VERSION"
      snapcraftctl set-version "$VERSION"
      snapcraftctl build
      sed -i 's|Icon=wpcom|Icon=/usr/share/icons/hicolor/256x256/apps/wpcom\.png|' ${SNAPCRAFT_PART_INSTALL}/usr/share/applications/wpcom.desktop
    build-packages:
      - curl
    stage-packages:
      - libnspr4
      - libnss3
      - libxkbfile1
      - libxss1
  cleanup:
    after: [ wordpress-desktop ]
    plugin: nil
    build-snaps: [ gnome-3-28-1804 ]
    override-prime: |
        set -eux
        cd /snap/gnome-3-28-1804/current
        find . -type f,l -exec rm -f $SNAPCRAFT_PRIME/{} \;

apps:
  wordpress-desktop:
    extensions: [gnome-3-28]
    command: opt/WordPress.com/wpcom
    desktop: usr/share/applications/wpcom.desktop
    environment:
      TMPDIR: $XDG_RUNTIME_DIR
    plugs:
      - browser-support
      - home
      - network
      - opengl
      - pulseaudio
      - unity7